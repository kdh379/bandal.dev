import { Image } from "@/components/Media";
import aiQuestion from "./perplexity-rsc-logging-question.png";

export const meta = {
  title: "Next.jsì—ì„œ íš¨ìœ¨ì ì¸ ë¡œê¹… êµ¬ì¡° ë§Œë“¤ê¸°",
  description:
    "ì„œë²„ ì‚¬ì´ë“œì™€ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œë¥¼ ì•„ìš°ë¥´ëŠ” íš¨ìœ¨ì ì¸ ë¡œê¹… ì „ëµê³¼ êµ¬í˜„ ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤.",
  date: "2025-06-13",
};

í”„ë¡œì íŠ¸ë¥¼ ìš´ì˜í•˜ë‹¤ ë³´ë©´ ì‚¬ìš©ìê°€ ì–´ë–»ê²Œ í–‰ë™í•˜ëŠ”ì§€, ì–´ë–¤ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•  í•„ìš”ê°€ ìˆì–´ìš”. ì´ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ ë¡œê·¸ ë°ì´í„°ë¥¼ ë¶„ì„í•´ì•¼ í•˜ëŠ”ë°, ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ê²ƒì„ **ë¡œê¹…(Logging)** ì´ë¼ê³  í•´ìš”.

ë¡œê¹…ì„ í†µí•´ ê¸°ë¡ëœ ë°ì´í„°ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”

- ì‚¬ìš©ìì˜ í–‰ë™ íŒ¨í„´ ì¶”ì 
- ì—ëŸ¬ ë°œìƒ ìƒí™© íŒŒì•…
- ì„±ëŠ¥ ë³‘ëª© ì§€ì  ë°œê²¬
- A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„

ì´ë²ˆ ê¸€ì—ì„œëŠ” Next.js í™˜ê²½ì—ì„œ **ìë™í™”ëœ ë¡œê¹… ì‹œìŠ¤í…œ**ì„ êµ¬ì¶•í•˜ì—¬ ê°œë°œìê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤.

## ê¸°ì¡´ ë¡œê¹… ë°©ì‹ì˜ ë¬¸ì œì 

íš¨ìœ¨ì ì¸ ë¡œê¹… êµ¬ì¡°ê°€ ì—†ì—ˆì„ ë• ì¤‘ìš”í•œ ë¡œì§ë§ˆë‹¤ ìˆ˜ë™ìœ¼ë¡œ ë¡œê¹… ì½”ë“œë¥¼ ì¶”ê°€í•´ì•¼ í–ˆì–´ìš”.

```typescript
async function createReservation(formData: FormSchema) {
  try {
    logger("ì˜ˆì•½ ë“±ë¡ API í˜¸ì¶œ ì‹œì‘");
    const response = await fetch(`/api/reservation/${productId}`, {
      method: "POST",
      body: JSON.stringify(formData),
    });

    if (!response.ok) {
      logger(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
      throw new Error("Create Reservation API fetch failed");
    }

    const reservationData = await response.json();
    logger("ì˜ˆì•½ ë“±ë¡ ì„±ê³µ:", reservationData.id);
    return reservationData;
  } catch (error) {
    logger("ì˜ˆì•½ ë“±ë¡ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error.message);
    throw error;
  }
}
```

### ì´ëŸ° ë°©ì‹ì˜ ë¬¸ì œì 

**1. ì½”ë“œ ê°€ë…ì„± ì €í•˜**

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¡œê¹… ë¡œì§ì´ ë’¤ì„ì—¬ ìˆì–´ìš”
- ì‹¤ì œ ì¤‘ìš”í•œ ë¡œì§ì„ íŒŒì•…í•˜ê¸° ì–´ë ¤ì›Œìš”

**2. ì¼ê´€ì„± ë¶€ì¡±**

- ê°œë°œìë§ˆë‹¤ ë‹¤ë¥¸ ë¡œê¹… í˜•ì‹ì„ ì‚¬ìš©í•´ìš”
- ë¡œê·¸ ë¶„ì„ ì‹œ í˜¼ë€ì„ ì•¼ê¸°í•´ìš”

**3. ëˆ„ë½ ê°€ëŠ¥ì„±**

- ìˆ˜ë™ìœ¼ë¡œ ë¡œê·¸ë¥¼ ì¶”ê°€í•˜ë‹¤ ë³´ë©´ ë¹ ëœ¨ë¦¬ê¸° ì‰¬ì›Œìš”
- ì¤‘ìš”í•œ ì—ëŸ¬ ìƒí™©ì„ ë†“ì¹  ìˆ˜ ìˆì–´ìš”

**4. ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€**

- ë¡œê¹… í˜•ì‹ ë³€ê²½ ì‹œ ëª¨ë“  ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼ í•´ìš”
- í™•ì¥ì„±ì´ ë–¨ì–´ì ¸ìš”

**5. ë¶„ì‚°ëœ ê´€ë¦¬**

- í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ë¡œê·¸ê°€ ë”°ë¡œ ê´€ë¦¬ë˜ì–´ìš”
- í†µí•©ì ì¸ ë¶„ì„ì´ ì–´ë ¤ì›Œìš”

### ìë™í™”ëœ ë¡œê¹…ì˜ ì¥ì 

ì´ëŸ° ë¬¸ì œë“¤ì„ í•´ê²°í•˜ê¸° ìœ„í•´ **ìë™í™”ëœ ë¡œê¹… ì‹œìŠ¤í…œ**ì„ êµ¬ì¶•í•˜ë©´:

- âœ… **ê¹”ë”í•œ ì½”ë“œ**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆì–´ìš”
- âœ… **ì¼ê´€ëœ í˜•ì‹**: í†µì¼ëœ ë¡œê·¸ êµ¬ì¡°ë¡œ ë¶„ì„ì´ ì‰¬ì›Œìš”
- âœ… **ëˆ„ë½ ë°©ì§€**: ì¤‘ìš”í•œ ì´ë²¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìº¡ì²˜í•´ìš”
- âœ… **í†µí•© ê´€ë¦¬**: ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬í•´ìš”

## Next.jsì˜ ë³µì¡í•œ ì‹¤í–‰ í™˜ê²½ ì´í•´í•˜ê¸°

Next.js App RouterëŠ” ì—¬ëŸ¬ ì‹¤í–‰ í™˜ê²½ì—ì„œ ì½”ë“œê°€ ë™ì‘í•´ìš”. ê° í™˜ê²½ì€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ë¡œê¹… ì „ëµì´ í•„ìš”í•´ìš”.

### ì£¼ìš” ì‹¤í–‰ í™˜ê²½

**ğŸŒ Client Component (ë¸Œë¼ìš°ì €)**

- ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰
- JavaScript ëŸ°íƒ€ì„ ì—ëŸ¬, ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
- `window` ê°ì²´ ì ‘ê·¼ ê°€ëŠ¥

**ğŸ–¥ï¸ Server Component (ì„œë²„)**

- Next.js ì„œë²„ì—ì„œ ì‹¤í–‰
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì—ëŸ¬, API í˜¸ì¶œ ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
- Node.js í™˜ê²½ì—ì„œ ë™ì‘

**ğŸšª Middleware (ì§„ì…ì )**

- ëª¨ë“  ìš”ì²­ì˜ ìµœìƒìœ„ì—ì„œ ì‹¤í–‰
- ì¸ì¦, ë¦¬ë‹¤ì´ë ‰ì…˜ ë¡œì§ì—ì„œ ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
- Edge Runtimeì—ì„œ ë™ì‘

**âŒ Error Pages (ì—ëŸ¬ ì²˜ë¦¬)**

- `error.tsx`, `not-found.tsx`ì—ì„œ ì‹¤í–‰
- ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ë‚˜ 404 ìƒí™© ì²˜ë¦¬

### í™˜ê²½ë³„ ë¡œê¹… ì „ëµì´ í•„ìš”í•œ ì´ìœ 

ê° í™˜ê²½ì€ ì„œë¡œ ë‹¤ë¥¸ íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆì–´ìš”:

| í™˜ê²½        | íŠ¹ì§•              | ì£¼ìš” ì—ëŸ¬ ìœ í˜•               |
| ----------- | ----------------- | ---------------------------- |
| Client      | ë¸Œë¼ìš°ì € API ì‚¬ìš© | ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬, ëŸ°íƒ€ì„ ì—ëŸ¬   |
| Server      | Node.js API ì‚¬ìš©  | ì„œë²„ ì—ëŸ¬, ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ |
| Middleware  | ì œí•œëœ API        | ì¸ì¦ ì—ëŸ¬, ë¦¬ë‹¤ì´ë ‰ì…˜ ì—ëŸ¬   |
| Error Pages | ì—ëŸ¬ ë³µêµ¬         | ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬             |

## ë‹¨ê³„ë³„ ë¡œê¹… ì‹œìŠ¤í…œ êµ¬ì¶•í•˜ê¸°

ì´ì œ ì‹¤ì œë¡œ Next.jsì—ì„œ ìë™í™”ëœ ë¡œê¹… ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

### 1ë‹¨ê³„: ê¸°ë³¸ ë¡œê±° í•¨ìˆ˜ ë§Œë“¤ê¸°

ë¨¼ì € í†µì¼ëœ ë¡œê·¸ í˜•ì‹ì„ ìœ„í•œ ê¸°ë³¸ ë¡œê±° í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ìš”. ë¡œê·¸ ìˆ˜ì§‘ í•¨ìˆ˜ëŠ” `"use server"`ë¥¼ ëª…ì‹œí•´ì„œ ì„œë²„ ì•¡ì…˜ìœ¼ë¡œ ìˆ˜í–‰í•˜ë„ë¡ í•´ìš”.

ì„œë²„ ì•¡ì…˜ì€ ì–´ëŠ í™˜ê²½ì—ì„œë“  í˜¸ì¶œí•  ìˆ˜ ìˆê³  ì—¬ëŸ¬ ë³´ì•ˆì  ì´ì ì„ ê°–ê³  ìˆì–´ìš”. ë¡œê·¸ì— ë¯¼ê° ì •ë³´ë¥¼ ì˜ëª» ë‚¨ê²¨ì„œ ë³´ì•ˆ ì‚¬ê³ ê°€ ë°œìƒí•  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ì„œë²„ ì•¡ì…˜ì„ ì‚¬ìš©í–ˆì–´ìš”. ìì„¸í•œ ë‚´ìš©ì€ ì´ì „ì— ì‘ì„±í•œ [React Hook Formì—ì„œ Next.js Server Actions ì‚¬ìš©í•˜ê¸°](/blog/react-hook-form-with-server-action)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.

```typescript
// [!code filename:lib/logger.ts]
"use server";

type EventType = "runtime_error" | "api_error" | "network_error" | "user_action";

interface LogData {
  eventType: EventType;
  message: string;
  ...
}

export function logger(logData: LogData) {
  // ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ë¡œê·¸ ë ˆë²¨ ê²°ì •
  const level = getLogLevelFromEventType(eventType);
  // í˜„ì¬ ì„¤ì •ëœ ë¡œê·¸ ë ˆë²¨ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
  if (!isLevelEnabled(level)) {
    return;
  }

  /**
   * ë¡œê·¸ ì „ë‹¬ í˜¹ì€ console.log ì¶œë ¥
   *
   * ì„œë²„ ì•¡ì…˜ìœ¼ë¡œ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì—, console.logë¡œ ë‚¨ê¸°ë”ë¼ë„ ì„œë²„ì˜ í„°ë¯¸ë„ì— ë‚¨ê²Œë˜ê³ ,
   * AWSë¥¼ ì‚¬ìš©í•œë‹¤ë©´ CloudWatch Logsì— ë‚¨ê²Œë˜ì–´ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
  */
}
```

### 2ë‹¨ê³„: í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ìë™ ìˆ˜ì§‘

ë¸Œë¼ìš°ì €ì—ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ìš”.

- ë¸Œë¼ìš°ì €ì—ì„œ ë°œìƒí•˜ëŠ” ëŸ°íƒ€ì„ ì—ëŸ¬ëŠ” ëª¨ë‘ `window.onerror` ë° `window.onunhandledrejection`ë¡œ ì „íŒŒë¼ìš”.
- ì´ ì›ë¦¬ë¥¼ ì´ìš©í•´ì„œ í•˜ë‚˜ì˜ ì»´í¬ë„ŒíŠ¸ì—ì„œ ëª¨ë“  ëŸ°íƒ€ì„ ì—ëŸ¬ë¥¼ ìº¡ì²˜í•  ìˆ˜ ìˆì–´ìš”.

```tsx
// [!code filename:components/RuntimeLogger.tsx]
"use client";

import { useEffect } from "react";
import { logger } from "./logger";

function setupRuntimeErrorHandlers() {
  if (typeof window !== "undefined") {
    // Reference Error, Type Error ë“± ëŸ°íƒ€ì„ ì—ëŸ¬ ìº¡ì²˜
    window.onerror = (message, source, _lineno, _colno, error) => {
      // error ê°ì²´ì—ëŠ” ë‹¤ìŒ ì •ë³´ë“¤ì´ í¬í•¨ë©ë‹ˆë‹¤:
      // - error.name: "ReferenceError" | "TypeError" ë“±
      // - error.message: "aaa is not defined" ë“±
      // - error.stack: ì—ëŸ¬ ë°œìƒ ìœ„ì¹˜ì˜ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤

      logger({
        eventType: "runtime_error",
        message: message.toString(),
        error: {
          name: error?.name,
          message: error?.message,
          stack: error?.stack,
          source: source,
        },
        userAgent: getBrowserInfo(),
      });
    };

    // async/awaitë‚˜ Promiseì—ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ ìº¡ì²˜
    window.onunhandledrejection = (event) => {
      const error = event.reason;

      logger({
        eventType: "runtime_error",
        message: error?.message,
        error: {
          name: error?.name,
          message: error?.message,
          stack: error?.stack,
        },
        userAgent: getBrowserInfo(),
      });
    };
  }
}

function RuntimeLogger() {
  useEffect(() => {
    setupRuntimeErrorHandlers();
  }, []);

  return null;
}
```

ë§Œë“  RuntimeLoggerë¥¼ ì•± ì „ì²´ì— ì ìš©í•´ìš”.

```tsx
// app/layout.tsx
import { RuntimeLogger } from "@/components/RuntimeLogger";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ko">
      <body>
        <RuntimeLogger />
        {children}
      </body>
    </html>
  );
}
```

### 3ë‹¨ê³„: Server Components ì—ëŸ¬ ìë™ ìˆ˜ì§‘

ì•„ë˜ ì´ìŠˆì—ì„œ íŒíŠ¸ë¥¼ ì–»ì—ˆì–´ìš”

- [vercel/next.js#54719](https://github.com/vercel/next.js/discussions/54719)

Next.JSëŠ” ì„œë²„ ì‚¬ì´ë“œì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ error.tsxë¡œ fallbackë˜ì–´ìš”. ì´ë•Œ ë³„ë„ì˜ ë¡œê¹…ì„ ë‚¨ê¸°ê³ ì í•˜ì—¬ë„, ë¹Œë“œ í™˜ê²½ì—ì„  ë¡œê¹…ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ì–´ìš”. error.tsxì—ì„œ `error.message`ë¥¼ ë³´ë©´, ì•„ë˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ê²Œ ë¼ìš”.

> [!danger]
>
> An error occurend in the Server Component render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additionnal details about the nature of the error. Error digest : XXXXXXXXXXXXX

ì´ ë©”ì‹œì§€ë¥¼ ë³´ë©´, ë¹Œë“œ í™˜ê²½ì—ì„  ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆ¨ê²¨ì ¸ ìˆì–´ìš”. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ê³µì‹ë¬¸ì„œì—ì„œ ì œê³µí•˜ëŠ” `instrumentation.ts`ë¥¼ ì‚¬ìš©í•´ìš”.

- [ê³µì‹ë¬¸ì„œ](https://nextjs.org/docs/app/api-reference/file-conventions/instrumentation#onrequesterror-optional)

> [!info]
>
> instrumentation.tsëŠ” ìµœê·¼ê¹Œì§€ `experimental` ìƒíƒœì˜€ì§€ë§Œ, í˜„ì¬ v15.3 ê¸°ì¤€ ì •ì‹ ê¸°ëŠ¥ì´ ë˜ì–´ìˆì–´ìš”. ì•„ì§ê¹Œì§€ AIì— ì§ˆë¬¸í•˜ê±°ë‚˜ êµ¬ê¸€ë§í•˜ì—¬ë„ Server Componentsì˜ ì—ëŸ¬ë¥¼ ê³µí†µí™”í•  ìˆ˜ ì—†ê³ , ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì§€ì ë§ˆë‹¤ ë¡œê¹… í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜ Sentryë¥¼ ë³´ë‚´ë¼ê³  ë‹µë³€í•´ìš”.

<Image src={aiQuestion} alt="AI ì§ˆë¬¸ ì˜ˆì‹œ" />

**í•˜ì§€ë§Œ ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ë¡œê¹…ì„ ê³µí†µí™”í•  ìˆ˜ ìˆì–´ìš”.**

```ts
// [!code filename:src/instrumentation.ts]
import { type Instrumentation } from "next";

export const onRequestError: Instrumentation.onRequestError = async (
  err,
  request,
  context,
) => {
  // í—¤ë” ì •ê·œí™”
  const normalizedHeaders: Record<string, string> = {};
  for (const [key, value] of Object.entries(request.headers)) {
    if (typeof value === "string") {
      normalizedHeaders[key] = value;
    } else if (Array.isArray(value)) {
      normalizedHeaders[key] = value.join(", ");
    } else if (value !== undefined) {
      normalizedHeaders[key] = String(value);
    }
  }

  logger({
    eventType: "server_error",
    message: err instanceof Error ? err.message : "Unknown error",
  });
};
```

ê° Parameterë³„ë¡œ ì•„ë˜ ì •ë³´ë¥¼ ë‹´ê³ ìˆì–´ìš”.

- `err`: `Error` ê°ì²´
- `request`:
  - path: í˜„ì¬ í˜ì´ì§€ ê²½ë¡œ
  - method: GET
  - headers: next/headers ì •ë³´
    - onRequestErrorë¡œ ì½œë°±ëœ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„  next/headers ë¥¼ í˜¸ì¶œí•´ë„ ë¹ˆ ê°’ì´ ë‚˜ì™€ìš”. ëŒ€ì‹  request.headersë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.
- `context`:
  - routerKind: ë¼ìš°í„° ì¢…ë¥˜ (`"App Router"` | `"Page Router"`)
  - routePath: í˜„ì¬ í˜ì´ì§€ ê²½ë¡œì¸ë°, dynamic routeì¼ ê²½ìš° `"/reserve/[id]"` ì²˜ëŸ¼ í‘œí˜„ë˜ì–´ìš”.
  - routeType: `"render"` (ì•„ì§ ë¬´ì—‡ì´ ë” ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ ëª»í–ˆì–´ìš”..)
  - renderSource: `"react-server-components"`

### 4ë‹¨ê³„: API í˜¸ì¶œ ë¡œê¹…

API í˜¸ì¶œ ì‹œ ë¡œê¹…ì€ ê° fetch í•¨ìˆ˜ í˜¸ì¶œë¶€ì—ì„œ ìˆ˜í–‰í•´ìš”.

- ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš°, RSC, CSCëŠ” `throw`ë¥¼ í†µí•´ ê³µí†µ ì—ëŸ¬ ì²˜ë¦¬ ì˜ì—­ìœ¼ë¡œ ì „íŒŒí•  ìˆ˜ ìˆì§€ë§Œ, Server Action ì—ì„œ ë°œìƒí•œ ì—ëŸ¬ëŠ” `throw`ë¥¼ ê¶Œì¥í•˜ì§€ ì•Šì•„ìš”. [ê³µì‹ë¬¸ì„œ](https://nextjs.org/docs/app/getting-started/error-handling#server-functions)
- ê¸°ë³¸ í˜•ì‹ ì™¸ ì¶”ê°€ì ì¸ ë©”íƒ€ ë°ì´í„°ë¥¼ ë‹´ê¸° ìœ„í•´, ê³µí†µ fetch í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ìš”.

```typescript
// lib/api-client.ts
import { logger } from "./logger";

export async function apiClient<T>(
  url: string,
  options: RequestInit = {},
): Promise<T> {
  const startTime = Date.now();

  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        ...options.headers,
      },
    });

    const duration = Date.now() - startTime;

    if (!response.ok) {
      // API ì—ëŸ¬ ë¡œê¹…
      logger({
        eventType: "api_error",
        message: `API request failed: ${response.status} ${response.statusText}`,
        // ... API ìš”ì²­/ì‘ë‹µ ë°ì´í„°
      });

      return {
        // ...ê°€ê³µëœ ì—ëŸ¬ ê°ì²´
      };
    }

    // ì„±ê³µì‹œ ë¡œê¹…
    logger({
      eventType: "fetch",
      message: "fetch success",
      // ... API ìš”ì²­/ì‘ë‹µ ë°ì´í„°
    });

    return response.json();
  } catch (error) {
    // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë¡œê¹…
    if (error instanceof TypeError) {
      logger({
        level: "error",
        eventType: "network_error",
      });
    }

    throw error;
  }
}
```

#### ì‚¬ìš© ì˜ˆì‹œ

ì´ì œ ê¹”ë”í•œ ì½”ë“œë¡œ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆì–´ìš”:

```typescript
// ê¸°ì¡´ ë°©ì‹ (ë¡œê¹… ì½”ë“œê°€ ì„ì—¬ìˆìŒ)
async function createReservationOld(formData: FormSchema) {
  try {
    console.log("ì˜ˆì•½ ë“±ë¡ API í˜¸ì¶œ ì‹œì‘");
    const response = await fetch("/api/reservation", {
      method: "POST",
      body: JSON.stringify(formData),
    });

    if (!response.ok) {
      console.error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
      throw new Error("API failed");
    }

    console.log("ì˜ˆì•½ ë“±ë¡ ì„±ê³µ");
    return response.json();
  } catch (error) {
    console.error("ì—ëŸ¬ ë°œìƒ:", error);
    throw error;
  }
}

// ê°œì„ ëœ ë°©ì‹ (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ìŒ)
async function createReservation(formData: FormSchema) {
  return apiClient("/api/reservation", {
    method: "POST",
    body: JSON.stringify(formData),
  });
}
```

### 5ë‹¨ê³„: Error pages ì²˜ë¦¬

ì°¸ì¡°: [Next.js Learn Chapter 13 - Handling Errors](https://nextjs.org/learn/dashboard-app/error-handling)

error.tsxì™€ not-foundëŠ” ê° ê³ ìœ  ì—­í• ë³„ë¡œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•´ìš”.

#### error.tsx

ì´ë¯¸ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì—ëŸ¬ëŠ” ë¡œê¹…ì„ ì²˜ë¦¬í–ˆê¸° ë•Œë¬¸ì—, ì´ê³³ì—ì„  ë³„ë„ì˜ ë¡œê¹…ì„ ì²˜ë¦¬í•˜ì§€ ì•Šì•„ìš”.  
ì„œë²„ ì‚¬ì´ë“œ ì—ëŸ¬ëŠ” production í™˜ê²½ì—ì„œ ì „íŒŒëœ ê²½ìš°, ë°ì´í„°ê°€ ìˆ¨ê²¨ì§€ê¸° ë•Œë¬¸ì— ë¡œê¹…í•  ìˆ˜ ì—†ì–´ìš”.

- í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì—ëŸ¬: `window.onerror`, `window.onunhandledrejection`ë¡œ ì²˜ë¦¬
- ì„œë²„ ì‚¬ì´ë“œ ì—ëŸ¬: instrumentation.tsì—ì„œ `onRequestError`ë¡œ ì²˜ë¦¬

> [!info]
>
> ë°°í¬ëœ í™˜ê²½ì—ì„  ì„œë²„ ì‚¬ì´ë“œì—ì„œ throwëœ ì—ëŸ¬ëŠ” error.tsxì—ì„œ `error.message`ë¥¼ ì°¸ì¡°í•˜ë©´ "An error occurred in the Server Components render." ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”.  
> Next.JSëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì„œë²„ì—ì„œ ë¯¼ê° ì •ë³´ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œ ìœ ì¶œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë©”ì‹œì§€ë¥¼ ì¼ë¶€ë¡œ ì œí•œí•´ìš”. ê·¸ë ‡ê¸° ë•Œë¬¸ì— error.tsxì— ë„ë‹¬í•˜ê¸° ì „ì— ë¡œê¹…ì„ ìˆ˜í–‰í•´ì•¼ í•´ìš”.

#### not-found.tsx

not-found.tsxëŠ” 404 ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•´ìš”.

ë§Œì•½, Programmatic Navigationì„ í†µí•´ 404 ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ê±°ë¼ë©´, ì´ í˜ì´ì§€ì—ì„œ ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆì–´ìš”.

```tsx
// [!code filename:app/not-found.tsx]
"use client";

export default function NotFound() {
  // ì‚¬ìš©ìê°€ ì£¼ì†Œì°½ì— ë§‰ ì…ë ¥í•´ì„œ ë“¤ì–´ì˜¨ ê²½ìš°
  const isDirectAccess = typeof window !== "undefined" && !document.referrer;

  useEffect(() => {
    if (isDirectAccess) return;

    logger({
      eventType: "not_found",
      message: "Page not found",
    });
  }, [isProgrammaticNavigation]);

  return <div>404 - Page Not Found</div>;
}
```

### 6ë‹¨ê³„: middleware.ts ì—ëŸ¬ ì²˜ë¦¬

middlewareëŠ”:

- ê¸°ë³¸ì ìœ¼ë¡œ **Edge Runtime**ì—ì„œ ì‹¤í–‰ë¼ìš”.
- ì´ëŠ” `layout.js` ë³´ë‹¤ ë” ìƒìœ„ ë ˆë²¨ë¡œ, ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” APIë„ ì œí•œë˜ì–´ ìˆì–´ìš”. [ì°¸ì¡°](https://nextjs.org/docs/app/api-reference/edge#reference)

middlewareì—ì„œëŠ” ê³µí†µ ì²˜ë¦¬ê°€ ë¶ˆê°€ëŠ¥í•´ì„œ, ìœ„ [5ë‹¨ê³„: Error pages ì²˜ë¦¬](#5-error-pages-)ì²˜ëŸ¼ ë³„ë„ì˜ `logger`í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì•¼í•´ìš”.

```ts
// [!code filename:src/middleware.ts]
import { NextResponse } from "next/server";

export function middleware(request: Request) {
  const response = NextResponse.next();

  // ë¦¬í”„ë˜ì‹œ í† í° ê°±ì‹  ë¡œì§
  try {
    const tokenResponse: NextResponse = await handleTokenRefresh(request);

    return tokenResponse;
  } catch (error) {
    logger({
      eventType: "middleware_error",
      message: "Failed to refresh token",
      error: error,
    });
  }

  return response;
}
```

## ë¡œê·¸ ë¶„ì„ì„ ìœ„í•œ ì¿¼ë¦¬ ì˜ˆì‹œ

êµ¬ì¶•í•œ ë¡œê¹… ì‹œìŠ¤í…œì˜ ë°ì´í„°ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë¶„ì„í•˜ê¸° ìœ„í•œ ì¿¼ë¦¬ë“¤ì„ ì†Œê°œí•´ìš”. ì´ ì˜ˆì‹œë“¤ì€ AWS CloudWatch Logs Insightsë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆì§€ë§Œ, ë‹¤ë¥¸ ë¡œê¹… ì„œë¹„ìŠ¤ì—ì„œë„ ë¹„ìŠ·í•˜ê²Œ í™œìš©í•  ìˆ˜ ìˆì–´ìš”.

### ê¸°ë³¸ ë¶„ì„ ì¿¼ë¦¬

```sql
-- ì „ì²´ ë¡œê·¸ ì¡°íšŒ
fields @timestamp, @message
| filter not isempty(timestamp)
| display timestamp, level, eventType, message, page.path
| sort timestamp desc
| limit 1000

-- ì—ëŸ¬ ë¡œê·¸ë§Œ ì¡°íšŒ
fields @timestamp, @message
| filter level = "error"
| display timestamp, eventType, message, error.name, error.message
| sort @timestamp desc
| limit 500

-- API ì—ëŸ¬ ë¶„ì„
fields @timestamp, @message
| filter eventType = "api_error"
| display timestamp, data.url, data.method, data.statusCode, message
| sort @timestamp desc
| limit 200
```

### ì„±ëŠ¥ ë¶„ì„ ì¿¼ë¦¬

```sql
-- HTTP ìƒíƒœ ì½”ë“œë³„ ìš”ì²­ ë¶„ì„
fields @timestamp, @message
| filter data.statusCode >= 400
| stats count(*) as errorCount by data.statusCode, data.url, data.method
| sort errorCount desc
| limit 20

-- ì‹œê°„ëŒ€ë³„ ì—ëŸ¬ ë°œìƒ ì¶”ì´
fields @timestamp, @message
| filter level = "error"
| stats count(*) as errorCount by bin(1h)
| sort @timestamp asc

-- í˜ì´ì§€ë³„ ì—ëŸ¬ ë°œìƒ ë¹ˆë„
fields @timestamp, @message
| filter level = "error"
| stats count(*) as errorCount by page.path
| sort errorCount desc
| limit 20
```

## ê²°ê³¼

ìœ„ ë°©ì‹ìœ¼ë¡œ Next.JSì—ì„œ íš¨ìœ¨ì ì¸ ë¡œê¹… ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆì—ˆì–´ìš”. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‚¬ì´ì‚¬ì´ ë¼ì›Œì ¸ìˆë˜ ë¡œê¹… í•¨ìˆ˜ë¥¼ ëª¨ë‘ ê±°ë‘¬ëƒˆê³ , ë¡œê¹…ì„ ì‹¤ìˆ˜ë¡œ ì¶”ê°€í•˜ê¸° ëª»í•´ ë°œìƒí•˜ëŠ” ë¬¸ì œë„ ì—†ì–´ì¡Œì–´ìš”. ì´ì œ ê°œë°œìë“¤ì€ ë” ì´ìƒ ë¡œê¹… ì½”ë“œë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê±±ì •í•˜ì§€ ì•Šì•„ë„ ë˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆì–´ìš”.

ìµœì¢…ì ìœ¼ë¡œ ì¤‘ìš”í•œê±´ ì–´ë””ì„œ ê³µí†µìœ¼ë¡œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í• ì§€ ê³ ë ¤í•˜ëŠ”ê±°ì˜€ì–´ìš”. Next.JSëŠ” ë‹¤ì–‘í•œ ì‹¤í–‰ í™˜ê²½ì„ ê°€ì§€ê³  ìˆì–´ì„œ í™˜ê²½ë³„ë¡œ ì–´ë–»ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ì§€ë¥¼ ê°€ì¥ ë§ì´ ê³ ë¯¼í–ˆì–´ìš”. ì´ ë¶€ë¶„ì„ ì˜ ê³ ë ¤í•˜ë©´ ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì¼ ìˆ˜ ìˆì–´ìš”.
